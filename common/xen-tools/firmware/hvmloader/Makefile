#
# Makefile
#
# Leendert van Doorn, leendert@watson.ibm.com
# Copyright (c) 2005, International Business Machines Corporation.
#
# This program is free software; you can redistribute it and/or modify it
# under the terms and conditions of the GNU General Public License,
# version 2, as published by the Free Software Foundation.
#
# This program is distributed in the hope it will be useful, but WITHOUT
# ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or
# FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License for
# more details.
#
# You should have received a copy of the GNU General Public License along with
# this program; if not, write to the Free Software Foundation, Inc., 59 Temple
# Place - Suite 330, Boston, MA 02111-1307 USA.
#

#
# uXen changes:
#
# Copyright 2012-2018, Bromium, Inc.
# SPDX-License-Identifier: ISC
#
# Permission to use, copy, modify, and/or distribute this software for any
# purpose with or without fee is hereby granted, provided that the above
# copyright notice and this permission notice appear in all copies.
#
# THE SOFTWARE IS PROVIDED "AS IS" AND THE AUTHOR DISCLAIMS ALL WARRANTIES
# WITH REGARD TO THIS SOFTWARE INCLUDING ALL IMPLIED WARRANTIES OF
# MERCHANTABILITY AND FITNESS. IN NO EVENT SHALL THE AUTHOR BE LIABLE FOR ANY
# SPECIAL, DIRECT, INDIRECT, OR CONSEQUENTIAL DAMAGES OR ANY DAMAGES
# WHATSOEVER RESULTING FROM LOSS OF USE, DATA OR PROFITS, WHETHER IN AN ACTION
# OF CONTRACT, NEGLIGENCE OR OTHER TORTIOUS ACTION, ARISING OUT OF OR IN
# CONNECTION WITH THE USE OR PERFORMANCE OF THIS SOFTWARE.
#

ifeq (,$(SRCDIR))
TOPDIR = ../../../..
include $(TOPDIR)/Config.mk
endif

SRCDIR ?= .
include $(SRCDIR)/Rules.mk

SUBDIRS :=
SUBDIRS += acpi

# The HVM loader is started in 32-bit mode at the address below:
LOADADDR = 0x100000

CFLAGS += $(CFLAGS_xeninclude) $(CFLAGS_commoninclude)

CPPFLAGS += -I.

CFLAGS += -m32
LDFLAGS_DIRECT += -melf_i386

OBJS  = hvmloader.o mp_tables.o util.o smbios.o 
OBJS += smp.o cacheattr.o modules.o
#OBJS += xenbus.o
OBJS += xenbus-stub.o
OBJS += e820.o pci.o pir.o
ifeq ($(debug),y)
OBJS += tests.o
endif

# Get gcc to generate the dependencies for us.
CFLAGS += -MMD -MF .$(@F).d
DEPS = .*.d

CIRRUSVGA ?= n
CIRRUSVGA_DEBUG ?= n

#ROMBIOS_DIR := ../rombios
ifneq ($(ROMBIOS_DIR),)
OBJS += rombios.o
OBJS += 32bitbios_support.o
CFLAGS += -DENABLE_ROMBIOS
ROMBIOS_ROM := $(ROMBIOS_DIR)/BIOS-bochs-latest
endif

#SEABIOS_DIR := ../../../seabios
ifneq ($(SEABIOS_DIR),)
OBJS += seabios.o
CFLAGS += -DENABLE_SEABIOS
SEABIOS_ROM := $(SEABIOS_DIR)/out/bios.bin
CFLAGS += -DENABLE_SEABIOS_VGA
SEABIOS_VGA_ROM := $(SEABIOS_DIR)/out/vgabios.bin
endif

#STDVGA_ROM    := ../vgabios/VGABIOS-lgpl-latest.bin
ifneq ($(STDVGA_ROM),)
CFLAGS += -DENABLE_STDVGA
endif
ifeq ($(CIRRUSVGA),y)
CFLAGS += -DENABLE_CIRRUSVGA
ifeq ($(CIRRUSVGA_DEBUG),y)
CIRRUSVGA_ROM := ../vgabios/VGABIOS-lgpl-latest.cirrus.debug.bin
else
CIRRUSVGA_ROM := ../vgabios/VGABIOS-lgpl-latest.cirrus.bin
endif
endif

ETHERBOOT_ROM_H := $(shell test -e ../etherboot/eb-roms.h && echo ../etherboot/eb-roms.h)

.PHONY: all
all: hvmloader

rombios.o seabios.o hvmloader.o: roms.inc
smbios.o: CFLAGS += -D__SMBIOS_DATE__="\"$(shell date +%m/%d/%Y)\""

hvmloader: $(OBJS) acpi/acpi.a
	$(LD) $(LDFLAGS_DIRECT) -N -Ttext $(LOADADDR) -o hvmloader.tmp $^
	$(OBJCOPY) hvmloader.tmp hvmloader
	rm -f hvmloader.tmp

acpi/acpi.a: subdir-all-acpi

roms.inc: $(ROMBIOS_ROM) $(SEABIOS_ROM) $(SEABIOS_VGA_ROM) $(STDVGA_ROM) $(CIRRUSVGA_ROM) $(ETHERBOOT_ROM_H)
	echo "/* Autogenerated file. DO NOT EDIT */" > $@.new

ifneq ($(ROMBIOS_ROM),)
	echo "#ifdef ROM_INCLUDE_ROMBIOS" >> $@.new
	sh $(SRCDIR)/mkhex rombios $(ROMBIOS_ROM) >> $@.new
	echo "#endif" >> $@.new
endif

ifneq ($(SEABIOS_ROM),)
	echo "#ifdef ROM_INCLUDE_SEABIOS" >> $@.new
	sh $(SRCDIR)/mkhex seabios $(SEABIOS_ROM) >> $@.new
	echo "#endif" >> $@.new
endif

ifneq ($(SEABIOS_VGA_ROM),)
	echo "#ifdef ROM_INCLUDE_SEABIOS_VGA" >> $@.new
	sh $(SRCDIR)/mkhex seabios_vga $(SEABIOS_VGA_ROM) >> $@.new
	echo "#endif" >> $@.new
endif

ifneq ($(STDVGA_ROM),)
	echo "#ifdef ROM_INCLUDE_VGABIOS" >> $@.new
	sh $(SRCDIR)/mkhex vgabios_stdvga $(STDVGA_ROM) >> $@.new
	echo "#endif" >> $@.new
endif
ifneq ($(CIRRUSVGA_ROM),)
	echo "#ifdef ROM_INCLUDE_VGABIOS" >> $@.new
	sh $(SRCDIR)/mkhex vgabios_cirrusvga $(CIRRUSVGA_ROM) >> $@.new
	echo "#endif" >> $@.new
endif

	echo "#ifdef ROM_INCLUDE_ETHERBOOT" >> $@.new
ifneq ($(ETHERBOOT_ROM_H),)
	cat $(ETHERBOOT_ROM_H) >> $@.new
else
	echo "#define ROM_NO_ETHERBOOT" >> $@.new
endif
	echo "#endif" >> $@.new

	mv $@.new $@

.PHONY: clean
clean: subdirs-clean
	rm -f roms.inc roms.inc.new acpi.h
	rm -f hvmloader hvmloader.tmp *.o $(DEPS)

-include $(DEPS)
